


/*
MEDICARE X - SISTEM PELAYANAN RUMAH SAKIT - SEDERHANA
Vonaquie Jojor Dwini Loan Pandiangan	251712034
Safwatun Naila	251712027
Farah Dhiba	251712038
Indah Febeyola Alessiandra Sijabat	251712030
*/



#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#ifdef _WIN32
    #include <windows.h>
    void sleep_seconds(int s) { Sleep(s * 1000); }
#else
    #include <unistd.h>
    void sleep_seconds(int s) { sleep(s); }
#endif

/* =============================== */
/*   EFEK LOADING & OUTPUT BERTAHAP */
/* =============================== */

void show_loading_dots(int dots) {
    if (dots <= 0) dots = 3;
    printf("Loading");
    fflush(stdout);
    for (int i = 0; i < dots; i++) {
        printf(".");
        fflush(stdout);
        sleep_seconds(1);
    }
    printf("\n");
}

/* Cetak teks, jeda 1 detik setiap newline */
void print_with_line_pause(const char *text) {
    for (int i = 0; text[i] != '\0'; i++) {
        putchar(text[i]);
        fflush(stdout);

        if (text[i] == '\n')
            sleep_seconds(1);
    }
}

/* Loading dulu, lalu tampilkan teks bertahap */
void loading_then_print(const char *text, int dots) {
    show_loading_dots(dots);
    print_with_line_pause(text);
}

/* -------------- end loading utils ------------- */

#define MAX_PATIENTS 200
#define NAME_LEN 100
#define PHONE_LEN 32
#define RUJUK_LEN 100
#define DIAG_LEN 256
#define HISTORY_LEN 1024
#define IDNO_LEN 32

typedef enum { PAY_MANDIRI = 0, PAY_BPJS = 1 } PayType;
typedef enum { ST_REG=0, ST_POLI_DONE=1, ST_APOTEK_DONE=2, ST_TEST_DONE=3, ST_INROOM=4, ST_DISCHARGED=5 } Stage;

typedef struct {
    unsigned long id;
    int queue_no;
    char name[NAME_LEN];
    int age;
    char phone[PHONE_LEN];
    char id_no[IDNO_LEN];       /* NIK / No.Identitas */
    int is_rujuk; /* 0/1 */
    char rujukan_from[RUJUK_LEN];
    char rujukan_no[32];
    char diagnosis_awal[DIAG_LEN];
    PayType paytype;
    char pay_no[64];
    char history[HISTORY_LEN];
    Stage stage;
} Patient;

/* Database sederhana */
static Patient patients[MAX_PATIENTS];
static int patient_count = 0;
static unsigned long next_id = 1;
static int next_queue = 1;

/* Prototypes */
int is_valid_worker(const char *user, const char *pass);
void read_line(char *buf, int size);
void append_history(Patient *p, const char *txt);
void formatRibuan(int nilai, char *out, int outsz);
const char* stage_name(Stage s);
void tampilkanRincian(const Patient *p);
Patient* find_by_queue(int q);
Patient* find_by_id(unsigned long id);
void register_patient(void);
void apotek_process_for_patient(Patient *p);
void apotek(void);
void kamar_langsung(Patient *p);
void kamar(void);
void poli_doctor(void);
void perform_test_choice(int type);
void list_patients(void);
void search_name(void);
void tindakan_menu(void);
int login(void);
void print_main_menu(void);

/* helper validation */
int is_digits(const char *s) {
    if (!s || s[0] == '\0') return 0;
    for (int i = 0; s[i]; ++i) if (!isdigit((unsigned char)s[i])) return 0;
    return 1;
}
int contains_alpha(const char *s) {
    if (!s) return 0;
    for (int i = 0; s[i]; ++i) if (isalpha((unsigned char)s[i])) return 1;
    return 0;
}

/* ---------------- helper ---------------- */
void read_line(char *buf, int size) {
    if (fgets(buf, size, stdin) == NULL) {
        buf[0] = '\0';
        return;
    }
    buf[strcspn(buf, "\n")] = '\0';
}

void append_history(Patient *p, const char *txt) {
    if (!p || !txt || txt[0] == '\0') return;
    if (p->history[0] == '\0') {
        strncpy(p->history, txt, HISTORY_LEN-1);
        p->history[HISTORY_LEN-1] = '\0';
    } else {
        strncat(p->history, "\n", HISTORY_LEN - strlen(p->history) - 1);
        strncat(p->history, txt, HISTORY_LEN - strlen(p->history) - 1);
    }
}

void formatRibuan(int nilai, char *out, int outsz) {
    char tmp[64];
    int idx = 0;
    int n = nilai;
    if (n == 0) { strncpy(out, "0", outsz-1); out[outsz-1] = '\0'; return; }
    int count = 0;
    while (n > 0 && idx < (int)sizeof(tmp)-1) {
        if (count == 3) { tmp[idx++] = '.'; count = 0; }
        tmp[idx++] = '0' + (n % 10);
        n /= 10;
        count++;
    }
    int j = 0;
    if (idx >= outsz) idx = outsz - 1;
    while (idx > 0 && j < outsz - 1) out[j++] = tmp[--idx];
    out[j] = '\0';
}

const char* stage_name(Stage s) {
    switch (s) {
        case ST_REG: return "Terdaftar (Pendaftaran)";
        case ST_POLI_DONE: return "Sudah ke POLI";
        case ST_APOTEK_DONE: return "Sudah ke Apotek";
        case ST_TEST_DONE: return "Sudah Tes/Cek";
        case ST_INROOM: return "Rawat Inap / Di Kamar";
        case ST_DISCHARGED: return "Pulang / Dirujuk";
        default: return "Unknown";
    }
}

/* ----------------- utilities ----------------- */
int is_valid_worker(const char *user, const char *pass) {
    if ((strcmp(user, "vonaquie") == 0 && strcmp(pass, "251712034") == 0) ||
        (strcmp(user, "safwatun") == 0 && strcmp(pass, "251712027") == 0) ||
        (strcmp(user, "farah") == 0 && strcmp(pass, "251712038") == 0) ||
        (strcmp(user, "indah") == 0 && strcmp(pass, "251712030") == 0)) {
        return 1;
    }
    return 0;
}

int login(void) {
    char user[64], pass[64];
    int attempts = 3;
    while (attempts-- > 0) {
        printf("\nUser: ");
        read_line(user, sizeof(user));
        printf("Password: ");
        read_line(pass, sizeof(pass));
        if (is_valid_worker(user, pass)) {
            /* tampilkan loading + pesan bertahap */
            loading_then_print("Login berhasil.\nLanjut ke sistem...\n", 2);
            return 1;
        }
        printf("Login salah. Sisa percobaan: %d\n", attempts);
    }
    return 0;
}

/* ----------------- CRUD & find ----------------- */
Patient* find_by_queue(int q) {
    for (int i = 0; i < patient_count; ++i) if (patients[i].queue_no == q) return &patients[i];
    return NULL;
}
Patient* find_by_id(unsigned long id) {
    for (int i = 0; i < patient_count; ++i) if (patients[i].id == id) return &patients[i];
    return NULL;
}

/* ----------------- Tampilkan ----------------- */
void tampilkanRincian(const Patient *p) {
    if (!p) return;
    char buf[1024];
    snprintf(buf, sizeof(buf),
             "\n---- Pasien ID %lu ----\n"
             "Nama    : %s\n"
             "Umur    : %d\n"
             "Telp    : %s\n"
             "NIK/ID  : %s\n",
             p->id, p->name, p->age, p->phone[0] ? p->phone : "(tidak ada)", p->id_no[0] ? p->id_no : "(tidak ada)");
    loading_then_print(buf, 1);

    if (p->is_rujuk) {
        char b2[512];
        snprintf(b2, sizeof(b2), "\nRujukan : Dari %s | No: %s\nDx awal : %s\n",
                 p->rujukan_from, p->rujukan_no, p->diagnosis_awal);
        print_with_line_pause(b2);
    }
    {
        char b3[256];
        snprintf(b3, sizeof(b3), "\nPembayaran : %s | No: %s\nStage : %s\n",
                 p->paytype == PAY_BPJS ? "BPJS" : "Mandiri", p->pay_no, stage_name(p->stage));
        print_with_line_pause(b3);
    }
    {
        char hist_buf[1200];
        snprintf(hist_buf, sizeof(hist_buf), "\nRiwayat:\n%s\n", p->history[0] ? p->history : "(kosong)");
        print_with_line_pause(hist_buf);
    }
}

/* ----------------- Pendaftaran (diperbaiki) ----------------- */
void register_patient(void) {
    if (patient_count >= MAX_PATIENTS) { printf("Penuh: tidak bisa menambah pasien lagi.\n"); return; }

    Patient tmp;
    tmp.id = next_id++;
    tmp.queue_no = next_queue++;
    tmp.age = 0;
    tmp.phone[0] = '\0';
    tmp.id_no[0] = '\0';
    tmp.is_rujuk = 0;
    tmp.rujukan_from[0] = '\0';
    tmp.rujukan_no[0] = '\0';
    tmp.diagnosis_awal[0] = '\0';
    tmp.pay_no[0] = '\0';
    tmp.history[0] = '\0';
    tmp.stage = ST_REG;

    char buf[256];

    printf("\n===--- 01 PENDAFTARAN ---===\n");

    /* Nama: validasi minimal ada huruf (hindari nama yang hanya angka) */
    while (1) {
        printf("Nama: ");
        read_line(tmp.name, NAME_LEN);
        if (tmp.name[0] == '\0') {
            printf("Nama kosong. Masukkan nama pasien.\n");
            continue;
        }
        if (!contains_alpha(tmp.name)) {
            printf("Nama harus mengandung huruf (tidak boleh hanya angka/symbol).\n");
            continue;
        }
        break;
    }

    /* Umur (sudah sesuai) */
    while (1) {
        printf("Umur: ");
        read_line(buf, sizeof(buf));
        if (sscanf(buf, "%d", &tmp.age) == 1 && tmp.age >= 0) break;
        printf("Umur tidak valid. Masukkan angka >= 0.\n");
    }

    /* NIK: wajib 16 digit angka */
    while (1) {
        printf("NIK / No. Identitas (16 digit angka): ");
        read_line(tmp.id_no, IDNO_LEN);
        if (strlen(tmp.id_no) == 16 && is_digits(tmp.id_no)) break;
        printf("NIK harus tepat 16 digit angka. Saat ini panjang=%zu.\n", strlen(tmp.id_no));
    }

    /* Telepon: hanya angka, panjang 6..15 */
    while (1) {
        printf("Telepon (hanya angka, 6-15 digit): ");
        read_line(tmp.phone, PHONE_LEN);
        size_t ln = strlen(tmp.phone);
        if (ln >= 6 && ln <= 15 && is_digits(tmp.phone)) break;
        printf("Telepon tidak valid: harus 6-15 digit angka. Saat ini panjang=%zu.\n", ln);
    }

    /* Rujukan? Jika ya, isi asal RS + no rujukan (7 atau 10 digit)
       Jika pasien mengisi no rujukan valid (7 atau 10 digit) maka kita
       otomatis menetapkan jenis pembayaran berdasarkan panjang no rujukan:
         - 7 digit, Mandiri
         - 10 digit, BPJS
       Sehingga kita TIDAK menanyakan ulang metode pembayaran.
       Jika pasien bukan rujukan, minta metode pembayaran manual:
         - Mandiri, wajib 7 digit angka (deposit)
         - BPJS, wajib 10 digit angka (nomor bpjs)
    */
    printf("Apakah pasien rujukan dari RS lain? (y/n): ");
    read_line(buf, sizeof(buf));
    if (buf[0] == 'y' || buf[0] == 'Y') {
        tmp.is_rujuk = 1;
        while (1) {
            printf("Asal rumah sakit: ");
            read_line(tmp.rujukan_from, RUJUK_LEN);
            if (tmp.rujukan_from[0] != '\0') break;
            printf("Asal rumah sakit tidak boleh kosong.\n");
        }

        while (1) {
            printf("No rujukan (7 digit=Mandiri / 10 digit=BPJS): ");
            read_line(tmp.rujukan_no, sizeof(tmp.rujukan_no));
            size_t ln = strlen(tmp.rujukan_no);
            if ((ln == 7 || ln == 10) && is_digits(tmp.rujukan_no)) break;
            printf("No rujukan harus 7 atau 10 digit angka. Saat ini panjang=%zu.\n", ln);
        }

        printf("Diagnosis awal: ");
        read_line(tmp.diagnosis_awal, DIAG_LEN);

        /* set payment otomatis berdasarkan panjang rujukan */
        if (strlen(tmp.rujukan_no) == 7) {
            tmp.paytype = PAY_MANDIRI;
            strncpy(tmp.pay_no, tmp.rujukan_no, sizeof(tmp.pay_no)-1);
            tmp.pay_no[sizeof(tmp.pay_no)-1] = '\0';
            append_history(&tmp, "Pembayaran otomatis: Mandiri (dari no rujukan 7 digit).");
        } else { /* 10 digit */
            tmp.paytype = PAY_BPJS;
            strncpy(tmp.pay_no, tmp.rujukan_no, sizeof(tmp.pay_no)-1);
            tmp.pay_no[sizeof(tmp.pay_no)-1] = '\0';
            append_history(&tmp, "Pembayaran otomatis: BPJS (dari no rujukan 10 digit).");
        }

        char t[512];
        snprintf(t, sizeof(t), "Rujukan dari %s | No:%s | Dx:%s",
                 tmp.rujukan_from[0] ? tmp.rujukan_from : "-",
                 tmp.rujukan_no[0] ? tmp.rujukan_no : "-",
                 tmp.diagnosis_awal[0] ? tmp.diagnosis_awal : "-");
        append_history(&tmp, t);

    } else {
        /* bukan rujukan -> tanyakan pembayaran manual dan validasi ketat sesuai permintaan */
        while (1) {
            printf("Pembayaran: 1=Mandiri  2=BPJS : ");
            read_line(buf, sizeof(buf));
            int p = atoi(buf);
            if (p == 2) {
                tmp.paytype = PAY_BPJS;
                /* WAJIB input 10 digit angka untuk BPJS */
                while (1) {
                    printf("Masukkan nomor BPJS (10 digit angka): ");
                    read_line(tmp.pay_no, sizeof(tmp.pay_no));
                    if (strlen(tmp.pay_no) == 10 && is_digits(tmp.pay_no)) break;
                    printf("Nomor BPJS harus tepat 10 digit angka. Saat ini panjang=%zu.\n", strlen(tmp.pay_no));
                }
                break;
            } else if (p == 1) {
                tmp.paytype = PAY_MANDIRI;
                /* WAJIB input 7 digit angka untuk deposit Mandiri */
                while (1) {
                    printf("Masukkan nomor deposit Mandiri (7 digit angka): ");
                    read_line(tmp.pay_no, sizeof(tmp.pay_no));
                    if (strlen(tmp.pay_no) == 7 && is_digits(tmp.pay_no)) break;
                    printf("Nomor deposit Mandiri harus tepat 7 digit angka. Saat ini panjang=%zu.\n", strlen(tmp.pay_no));
                }
                break;
            } else {
                printf("Pilihan tidak valid.\n");
            }
        }

        {
            char base[256];
            snprintf(base, sizeof(base), "Terdaftar: ID=%lu Antrian=%d Pembayaran=%s No:%s",
                     tmp.id, tmp.queue_no, tmp.paytype==PAY_BPJS?"BPJS":"Mandiri", tmp.pay_no);
            append_history(&tmp, base);
        }
    }

    /* simpan ke "database" */
    patients[patient_count++] = tmp;

    /* pendaftaran sukses: tampilkan loading + rincian singkat bertahap */
    {
        char tempMsg[256];
        snprintf(tempMsg, sizeof(tempMsg),
                 "Pendaftaran berhasil!\nID Pasien: %lu\nNomor Antrian: %d\n",
                 tmp.id, tmp.queue_no);
        loading_then_print(tempMsg, 3);
    }
}

/* ----------------- Apotek (otomatis untuk pointer pasien) ----------------- */
void apotek_process_for_patient(Patient *p) {
    if (!p) return;
    char buf[256];

    loading_then_print("\n=== APOTEK (langsung) ===\n", 1);
    tampilkanRincian(p);

    printf("Masukkan resep / aturan pakai: ");
    read_line(buf, sizeof(buf));
    if (buf[0]) {
        char note[300];
        snprintf(note, sizeof(note), "Resep/Aturan: %s", buf);
        append_history(p, note);
    }

    /* Jika BPJS, tidak minta pembayaran obat */
    if (p->paytype == PAY_BPJS) {
        append_history(p, "Apotek: pasien BPJS, obat ditanggung BPJS (tidak bayar).");
        p->stage = ST_APOTEK_DONE;
        loading_then_print("Pasien BPJS � tidak perlu bayar obat. Resep dicatat.\n", 2);
        return;
    }

    /* Mandiri: minta pembayaran */
    int biaya_obat = 25000;
    char biaya_str[64];
    formatRibuan(biaya_obat, biaya_str, sizeof(biaya_str));
    {
        char s[128];
        snprintf(s, sizeof(s), "Biaya obat = Rp. %s\nPembayaran lunas? (y/n): ", biaya_str);
        print_with_line_pause(s);
    }

    read_line(buf, sizeof(buf));
    if (!(buf[0]=='y' || buf[0]=='Y')) {
        append_history(p, "Apotek: pembayaran obat belum lunas.");
        loading_then_print("Pembayaran obat belum lunas. Ambil obat dihentikan.\n", 1);
        return;
    }

    append_history(p, "Obat diambil di apotek.");
    p->stage = ST_APOTEK_DONE;
    loading_then_print("Selesai proses apotek untuk pasien.\n", 1);
}

/* ----------------- Apotek (manual via menu) ----------------- */
void apotek(void) {
    char buf[256];
    printf("\n=== 03 Apotek ===\nMasukkan nomor antrian pasien (0 batal): ");
    read_line(buf, sizeof(buf));
    int q = atoi(buf);
    if (q == 0) return;
    Patient *p = find_by_queue(q);
    if (!p) { printf("Nomor antrian %d tidak ditemukan.\n", q); return; }
    if (p->stage < ST_POLI_DONE) { printf("Pasien belum mendapat resep dari dokter.\n"); return; }

    loading_then_print("Masukkan resep / aturan pakai:\n", 1);
    read_line(buf, sizeof(buf));
    if (buf[0]) append_history(p, buf);

    if (p->paytype == PAY_BPJS) {
        append_history(p, "Apotek: pasien BPJS, obat ditanggung BPJS (tidak bayar).");
        p->stage = ST_APOTEK_DONE;
        loading_then_print("Pasien BPJS � tidak perlu bayar obat. Resep dicatat.\n", 1);
        return;
    }

    int biaya_obat = 25000;
    char biaya_str[64];
    formatRibuan(biaya_obat, biaya_str, sizeof(biaya_str));
    {
        char s[128];
        snprintf(s, sizeof(s), "Biaya obat = Rp. %s\nPembayaran lunas? (y/n): ", biaya_str);
        print_with_line_pause(s);
    }
    read_line(buf, sizeof(buf));
    if (!(buf[0]=='y' || buf[0]=='Y')) {
        append_history(p, "Pembayaran apotek belum lunas.");
        loading_then_print("Pembayaran obat belum lunas. Proses dihentikan.\n", 1);
        return;
    }
    append_history(p, "Obat diambil di apotek.");
    p->stage = ST_APOTEK_DONE;
    loading_then_print("Selesai proses apotek untuk pasien.\n", 1);
}

/* ----------------- Kamar (otomatis) ----------------- */
void kamar_langsung(Patient *p) {
    if (!p) return;
    char buf[64];
    loading_then_print("\n=== 05 Kamar (langsung) ===\n", 1);
    tampilkanRincian(p);

    printf("1 = Check-in\n2 = Check-out\nPilih: ");
    read_line(buf, sizeof(buf));
    int ch = atoi(buf);

    if (ch == 1) {
        append_history(p, "Masuk kamar (check-in).");
        p->stage = ST_INROOM;
        loading_then_print("Pasien check-in.\n", 1);
    } else if (ch == 2) {
        append_history(p, "Keluar kamar (check-out).");
        p->stage = ST_DISCHARGED;
        loading_then_print("Pasien check-out.\n", 1);
    } else {
        printf("Pilihan tidak valid.\n");
    }
}

/* ----------------- Kamar (manual menu) ----------------- */
void kamar(void) {
    char buf[256];
    printf("\n=== 05 Kamar ===\nMasukkan ID pasien (0 batal): ");
    read_line(buf, sizeof(buf));
    unsigned long id = strtoul(buf, NULL, 10);
    if (id == 0) return;
    Patient *p = find_by_id(id);
    if (!p) { printf("Pasien ID %lu tidak ditemukan.\n", id); return; }
    tampilkanRincian(p);

    printf("1=Check-in (masuk kamar)\n2=Check-out (pulang)\nPilih: ");
    read_line(buf, sizeof(buf));
    int ch = atoi(buf);
    if (ch == 1) {
        append_history(p, "Masuk kamar / dirawat (check-in).");
        p->stage = ST_INROOM;
        loading_then_print("Pasien check-in.\n", 1);
    } else if (ch == 2) {
        append_history(p, "Keluar / pulang (check-out).");
        p->stage = ST_DISCHARGED;
        loading_then_print("Pasien dipulangkan.\n", 1);
    } else {
        printf("Batal.\n");
    }
}

/* ----------------- POLI / Dokter ----------------- */
void poli_doctor(void) {
    char buf[512];
    loading_then_print("\n=== 02 POLI/Dokter ===\n", 1);
    printf("Masukkan nomor antrian pasien (0 batal): ");
    read_line(buf, sizeof(buf));
    int q = atoi(buf);
    if (q == 0) return;

    Patient *p = find_by_queue(q);
    if (!p) { printf("Nomor antrian %d tidak ditemukan.\n", q); return; }

    tampilkanRincian(p);
    printf("Hasil pemeriksaan (satu baris): ");
    read_line(buf, sizeof(buf));
    if (buf[0]) append_history(p, buf);

    printf("\n\n1=Rawat Jalan (obat)\n2=Rawat Inap\n3=Operasi (rawat inap)\n4=Rujuk ke RS lain\nPilih Keputusan dokter: ");
    read_line(buf, sizeof(buf));
    int k = atoi(buf);

    if (k == 1) {
        append_history(p, "Keputusan: Rawat jalan (resep obat).");

        /* Jika BPJS, tidak perlu bayar, langsung ST_POLI_DONE lalu ke apotek otomatis */
        if (p->paytype == PAY_BPJS) {
            append_history(p, "POLI: pasien BPJS - pelayanan gratis (tidak minta pembayaran).");
            p->stage = ST_POLI_DONE;
            loading_then_print("Pasien BPJS � tidak perlu bayar pelayanan POLI. Langsung diarahkan ke Apotek.\n", 2);
            apotek_process_for_patient(p);
            return;
        }

        /* Mandiri, minta pembayaran poli */
        int biaya = 50000;
        char biaya_str[64];
        formatRibuan(biaya, biaya_str, sizeof(biaya_str));
        {
            char s[128];
            snprintf(s, sizeof(s), "Biaya pelayanan (poli + resep) = Rp. %s\nPembayaran lunas? (y/n): ", biaya_str);
            print_with_line_pause(s);
        }

        read_line(buf, sizeof(buf));
        if (!(buf[0]=='y' || buf[0]=='Y')) {
            append_history(p, "Pembayaran POLI belum lunas.");
            loading_then_print("Pembayaran belum lunas. Proses ditunda.\n", 1);
            return;
        }

        append_history(p, "Pembayaran POLI lunas.");
        p->stage = ST_POLI_DONE;
        loading_then_print("Pasien diarahkan ke Apotek.\n", 1);

        /* otomatis lanjut ke apotek untuk pasien Mandiri */
        apotek_process_for_patient(p);
        return;
    }
    else if (k == 2) {
        append_history(p, "Keputusan: Rawat inap (masuk kamar).");
        p->stage = ST_INROOM;
        loading_then_print("Pasien perlu rawat inap. Mengarahkan ke kamar...\n", 1);

        /* otomatis check-in kamar */
        kamar_langsung(p);
        return;
    }
    else if (k == 3) {
        append_history(p, "Keputusan: Operasi (rawat inap).");
        p->stage = ST_INROOM;
        loading_then_print("Operasi: lanjut ke kamar (persiapan)...\n", 1);

        kamar_langsung(p);
        append_history(p, "Operasi: catatan persiapan operasi ditambahkan.");
        return;
    }
    else if (k == 4) {
        append_history(p, "Keputusan: Rujuk ke RS lain.");
        p->stage = ST_DISCHARGED;
        if (p->paytype == PAY_MANDIRI) {
            append_history(p, "Rujuk: keluarkan nomor (Mandiri).");
            char out[200];
            snprintf(out, sizeof(out), "Output nomor rujukan (gunakan No Pembayaran/ID): %s\n", p->pay_no);
            loading_then_print(out, 1);
        } else {
            append_history(p, "Rujuk: keluarkan nomor (BPJS).");
            char out[200];
            snprintf(out, sizeof(out), "Output nomor rujukan (BPJS): %s\n", p->pay_no);
            loading_then_print(out, 1);
        }
        return;
    }
    else {
        printf("Pilihan tidak valid.\n");
        return;
    }
}

/* ----------------- Tes / Cek (DIUBAH: BPJS boleh ikut, tetapi TES tetap berbayar) ----------------- */
void perform_test_choice(int type) {
    char buf[512];
    loading_then_print("\n=== 04 TES / CEK ===\n", 1);
    printf("Masukkan nomor antrian pasien (0 batal): ");
    read_line(buf, sizeof(buf));
    int q = atoi(buf);
    if (q == 0) return;
    Patient *p = find_by_queue(q);
    if (!p) { printf("Nomor antrian %d tidak ditemukan.\n", q); return; }

    /* Tes boleh untuk Mandiri & BPJS. Namun TES tetap berbayar untuk kedua tipe. */
    int biaya = (type == 1) ? 100000 : 200000;
    const char *judul = (type == 1) ? "Tes Narkoba" : "Cek Kesehatan";
    char biaya_str[64];
    formatRibuan(biaya, biaya_str, sizeof(biaya_str));

    {
        char s[256];
        snprintf(s, sizeof(s), "\n--- %s ---\nBiaya: Rp. %s\nPembayaran lunas? (y/n): ", judul, biaya_str);
        print_with_line_pause(s);
    }
    read_line(buf, sizeof(buf));
    if (!(buf[0]=='y' || buf[0]=='Y')) {
        char t[256];
        snprintf(t, sizeof(t), "%s: pembayaran belum lunas.", judul);
        append_history(p, t);
        loading_then_print("Pembayaran belum lunas. Proses dibatalkan.\n", 1);
        return;
    }

    /* Jika lunas, lanjut input hasil */
    char hasil[512];
    printf("Masukkan kondisi/hasil pemeriksaan (satu baris): ");
    read_line(hasil, sizeof(hasil));
    if (hasil[0] == '\0') strcpy(hasil, "(tidak diisi)");
    printf("\n");

    char hist[768];
    snprintf(hist, sizeof(hist), "%s hasil: %s | biaya Rp.%s | pembayaran lunas | TipePembayaran=%s",
             judul, hasil, biaya_str, p->paytype==PAY_BPJS?"BPJS":"Mandiri");
    append_history(p, hist);
    p->stage = ST_TEST_DONE;

    /* cetak surat bertahap dengan loading */
    char surat[1024];
    snprintf(surat, sizeof(surat),
             "\n--- SURAT KETERANGAN %s ---\n"
             "Nama                : %s\n"
             "Umur                : %d\n"
             "NIK / No Identitas  : %s\n"
             "Nomor telepon       : %s\n"
             "Hasil               : %s\n"
             "Tipe Pembayaran     : %s\n"
             "---------- End of Surat ----------\n",
             (type==2?"HASIL CEK KESEHATAN":"HASIL TES NARKOBA"),
             p->name, p->age, p->id_no[0] ? p->id_no : "(tidak ada)",
             p->phone[0] ? p->phone : "(tidak ada)", hasil, p->paytype==PAY_BPJS?"BPJS":"Mandiri");
    loading_then_print(surat, 3);

    {
        char done[128];
        snprintf(done, sizeof(done), "\nTindakan %s selesai untuk pasien ID %lu\n", judul, p->id);
        loading_then_print(done, 1);
    }
}

/* ----------------- List / Search ----------------- */
void list_patients(void) {
    if (patient_count == 0) { loading_then_print("Belum ada pasien terdaftar.\n", 1); return; }
    loading_then_print("\n=== Daftar Pasien ===\n", 1);
    for (int i = 0; i < patient_count; ++i) {
        char line[256];
        snprintf(line, sizeof(line), "[%d] ID:%lu Q:%d Name:%s | Stage:%s\n",
               i+1, patients[i].id, patients[i].queue_no, patients[i].name, stage_name(patients[i].stage));
        print_with_line_pause(line);
    }
}

void search_name(void) {
    char q[NAME_LEN];
    printf("Masukkan nama/substring: ");
    read_line(q, sizeof(q));
    int found = 0;
    loading_then_print("Mencari...\n", 1);
    for (int i = 0; i < patient_count; ++i) {
        if (q[0] == '\0' || strstr(patients[i].name, q)) {
            tampilkanRincian(&patients[i]);
            found = 1;
        }
    }
    if (!found) loading_then_print("Tidak ditemukan pasien dengan nama tersebut.\n", 1);
}

/* ----------------- Tindakan menu (02/04) ----------------- */
void tindakan_menu(void) {
    char buf[32];
    while (1) {
        printf("\nTindakan yang dipilih:\n");
        printf("02: POLI/Dokter\n");
        printf("04: Tes / Cek\n");
        printf("03: Apotek (manual)\n");
        printf("05: Kamar (manual)\n");
        printf("0: Kembali\n");
        printf("Pilih 02/04/03/05: ");
        read_line(buf, sizeof(buf));
        if (strcmp(buf, "0") == 0) return;
        if (strcmp(buf, "02") == 0 || strcmp(buf, "2") == 0) {
            poli_doctor();
        } else if (strcmp(buf, "04") == 0 || strcmp(buf, "4") == 0) {
            printf("\nSubmenu Tes:\n");
            printf("01: Tes Narkoba (Rp100.000)\n");
            printf("02: Cek Kesehatan (Rp200.000)\n");
            printf("0: Batal\n");
            printf("Pilih 01/02: ");
            read_line(buf, sizeof(buf));
            if (strcmp(buf, "0") == 0) continue;
            if (strcmp(buf, "01") == 0 || strcmp(buf, "1") == 0) perform_test_choice(1);
            else if (strcmp(buf, "02") == 0 || strcmp(buf, "2") == 0) perform_test_choice(2);
            else printf("Pilihan tidak valid.\n");
        } else if (strcmp(buf, "03") == 0 || strcmp(buf, "3") == 0) {
            apotek();
        } else if (strcmp(buf, "05") == 0 || strcmp(buf, "5") == 0) {
            kamar();
        } else {
            printf("Pilihan tidak valid. Masukkan 02 atau 04 atau 03 atau 05.\n");
        }
    }
}

/* ----------------- Menuuh utamahh ----------------- */
void print_main_menu(void) {
    printf("\n--- Menu Utama ---\n");
    printf("1: Pendaftaran\n");
    printf("2: Tindakan (02/04)\n");
    printf("3: List / Search\n");
    printf("0: Keluar\n");
}

int main(void) {
    char buf[64];

    loading_then_print("===== SISTEM PELAYANAN MEDICARE X =====\n\n", 2);
    printf("Login Pegawai Medicare X\n");
    if (!login()) { loading_then_print("Login gagal. Program keluar.\n", 1); return 0; }

    while (1) {
        print_main_menu();
        printf("Pilih (1 / 2 / 3 / 0): ");
        read_line(buf, sizeof(buf));
        int opt = atoi(buf);
        if (opt == 0) {
            loading_then_print("Selesai. Sampai jumpa :) \n semoga tetap sehat yaww \n", 2);
            return 0;
        }
        switch (opt) {
            case 1: register_patient(); break;
            case 2: tindakan_menu(); break;
            case 3: {
                printf("1: Tampilkan semua\n2: Cari nama\nPilih: ");
                read_line(buf, sizeof(buf));
                int m = atoi(buf);
                if (m == 1) list_patients();
                else if (m == 2) search_name();
                else printf("Pilihan tidak valid.\n");
                break;
            }
            default: printf("Pilihan tidak valid.\n"); break;
        }
    }
    return 0;
}
